<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Provider</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='white'/%3E%3C/svg%3E">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        .state-info {
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 10px;
            backdrop-filter: blur(10px);
        }
        .loading {
            text-align: center;
            color: white;
            font-size: 1.2em;
            padding: 40px;
        }
        .user-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .user-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .user-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }
        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: block;
            border: 3px solid #667eea;
            object-fit: cover;
        }
        .user-info {
            margin-bottom: 20px;
        }
        .user-field {
            margin-bottom: 12px;
        }
        .field-label {
            font-size: 0.85em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .field-value {
            font-size: 1.1em;
            color: #333;
            font-weight: 500;
        }
        .select-button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }
        .select-button:hover {
            opacity: 0.9;
        }
        .select-button:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>Test Login Provider</h1>
        <div id="stateDisplay"></div>
    </header>
    <div id="content">
        <p class="loading">Loading users...</p>
    </div>
</div>

<script>
    let retryCounter = 0;
    let stateParam = null;
    let redirectParam = null;

    // Read state query parameter
    function getQueryParameter(paramName) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(paramName);
    }

    // Display state parameter if it exists
    function displayState(state) {
        const stateDisplay = document.getElementById('stateDisplay');
        if (state) {
            stateDisplay.innerHTML = `<div class="state-info">State: ${state}</div>`;
        }
    }

    // Fetch users from API
    async function fetchUsers() {
        try {
            const response = await fetch('/api/v1/test-users');

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const users = await response.json();
            displayUsers(users);

        } catch (error) {
            handleError(error);
        }
    }

    // Display users in grid
    function displayUsers(users) {
        const content = document.getElementById('content');

        if (Object.keys(users).length === 0) {
            content.innerHTML = '<p class="loading">No users found.</p>';
            return;
        }

        let html = '<div class="user-grid">';

        for (const [key, user] of Object.entries(users)) {
            html += `
                    <div class="user-card">
                        ${user.avatarUrl ? `<img src="${user.avatarUrl}" alt="${user.name || 'User'}" class="user-avatar" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-size=%2240%22 fill=%22%23999%22%3E?%3C/text%3E%3C/svg%3E'">` : ''}
                        <div class="user-info">
                            ${user.authenticationProviderId ? `
                                <div class="user-field">
                                    <div class="field-label">Provider ID</div>
                                    <div class="field-value">${user.authenticationProviderId}</div>
                                </div>
                            ` : ''}
                            ${user.name ? `
                                <div class="user-field">
                                    <div class="field-label">Name</div>
                                    <div class="field-value">${user.name}</div>
                                </div>
                            ` : ''}
                            ${user.email ? `
                                <div class="user-field">
                                    <div class="field-label">Email</div>
                                    <div class="field-value">${user.email}</div>
                                </div>
                            ` : ''}
                            ${user.username ? `
                                <div class="user-field">
                                    <div class="field-label">Username</div>
                                    <div class="field-value">${user.username}</div>
                                </div>
                            ` : ''}
                        </div>
                        <button class="select-button" onclick='selectUser(${JSON.stringify(user)})'>Select User</button>
                    </div>
                `;
        }

        html += '</div>';
        content.innerHTML = html;
    }
    
    function handleError(error) {
        alert(`Error loading users: ${error.message}`);
        // Clear content and retry
        if (retryCounter < 3) {
            document.getElementById('content').innerHTML = '<p class="loading">Retrying...</p>';
            fetchUsers();
        } else {
            document.getElementById('content').innerHTML = '<p class="loading">Failed to get test-users</p>';
        }
        
        retryCounter++
    }

    // Button click handler (does nothing for now)
    function selectUser(user) {
        window.location.replace(`api/v1/OAuth/Authorize/Test/?redirect_uri=${encodeURIComponent(redirectParam)}&state=${stateParam}&code=${user.authenticationProviderId}`);
    }

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', () => {
        stateParam = getQueryParameter("state");
        redirectParam = getQueryParameter("redirect_uri");
        displayState(stateParam);
        fetchUsers();
    });
</script>
</body>
</html>